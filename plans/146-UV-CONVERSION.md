## 146 - UV CONVERSION IMPLEMENTATION PLAN

### Overview
- **Goal**: Migrate project environment and dependency management from Conda to `uv` while keeping Docker, `Makefile`, and local dev flows smooth.
- **Scope**: Python environment management, dependency specification/locking, Docker build process, and developer onboarding/docs.
- **Constraints**:
  - Preserve existing runtime behavior (same Python version, same key dependencies).
  - Avoid breaking CI, `docker compose` workflows, or `make` targets.
  - Prefer minimal extra tooling; rely on `uv` + standard Python where possible.

### Current State Analysis
- **Environment definitions**:
  - `linux_environment.yml`, `linux_environment_x86_x64.yml`, `mac_environment_arm.yml` define Conda envs.
  - `conda-install.sh` bootstraps Conda-based environments.
- **Docker & runtime**:
  - `Dockerfile` and `docker-compose.yml` build and run the backend with Conda.
  - `Makefile` targets (`make build`, `make run`, `make empty`) assume Conda/`environment.yml`-style setup.
  - Backend container name `backend` is used for `docker exec` commands in docs/rules.
- **Python dependencies**:
  - Requirements currently derive from Conda env files (plus manual installs via `conda env export`).
  - No canonical `pyproject.toml` / `requirements.txt` fully owned by `uv` yet.

### Target Architecture with `uv`
- **Environment management**:
  - Use `uv` as the primary tool for:
    - Creating and managing virtual environments.
    - Installing and locking Python dependencies.
  - Replace Conda env files with `uv`-managed lockfiles and minimal metadata.
- **Dependency specification**:
  - Introduce a canonical dependency specification:
    - Option A (preferred): `pyproject.toml` with dependency lists; `uv.lock` as the lockfile.
    - Option B: `requirements.lock` generated by `uv` (if we choose not to introduce `pyproject` yet).
  - Keep any non-Python system dependencies documented in `Dockerfile` comments/README.
- **Docker integration**:
  - Docker images install `uv` and use it to:
    - Sync dependencies based on lockfile.
    - Run the app via `uv run` (or activate the `uv`-created venv).
- **Developer workflow**:
  - Local dev uses `uv` commands instead of Conda:
    - `uv venv`, `uv sync`, `uv run`, etc.
  - Keep `make` targets as the primary entrypoints, but internally switch them to `uv`.

### Phase 1: Inventory and Baseline
1. **Extract canonical dependency list from Conda envs**
   - Parse `linux_environment.yml`, `linux_environment_x86_x64.yml`, and `mac_environment_arm.yml`.
   - Identify:
     - Python version.
     - Core Python packages (and versions) actually used by the project.
     - Any Conda-only/system-level deps that must be replicated via `apt` in Docker.
2. **Verify runtime expectations**
   - Confirm:
     - Minimum Python version we support.
     - CUDA/GPU or ML-specific dependencies required by MLX, vLLM, Sesame, etc.
   - Note any platform-specific packages that may require conditional handling with `uv`.

### Phase 2: Introduce `uv` Project Definition
1. **Add `pyproject.toml` (or update if present)**
   - Define:
     - Project metadata (name, version, description, authors).
     - `requires-python` matching current Conda Python version.
     - `dependencies` list based on extracted inventory (Pin versions where needed; leave others with compatible ranges).
   - Add optional `dev-dependencies` for testing, linting, and tooling (`pytest`, `mypy`, etc.).
2. **Generate `uv` lockfile**
   - Run `uv lock` to create `uv.lock` capturing fully-resolved versions.
   - Verify lockfile includes all required packages for:
     - Backend server.
     - Agents and ML architectures (LLama, Sesame, Moshi, etc.).
     - Tests and migrations.
3. **Add `uv`-specific ignore rules**
   - Ensure lockfiles and `__pycache__` remain handled via `.gitignore` as appropriate.
   - Do **not** ignore `uv.lock` (it should be version-controlled).

### Phase 3: Local Development Workflow Migration
1. **Add `uv` bootstrap instructions**
   - Create or update a short script (e.g., `uv-setup.sh`) and/or README section describing:
     - Installing `uv` on macOS/Linux.
     - Creating the venv: `uv venv .venv`.
     - Syncing dependencies: `uv sync`.
2. **Update `Makefile` targets**
   - Update `make empty`, `make build`, `make run`, and any other Python-related targets to:
     - Use `uv run` instead of Conda activation.
     - Example:
       - `make build`: `uv sync` then build Docker images.
       - `make run`: ensure env is synced, then `docker compose up` with the correct env.
3. **Deprecate Conda scripts for local dev**
   - Mark `conda-install.sh` as deprecated in comments.
   - Optionally keep it temporarily for transition, but:
     - Add a comment banner directing developers to `uv`-based instructions.

### Phase 4: Docker & Compose Migration
1. **Update `Dockerfile` to use `uv`**
   - Install `uv` in the base image (via `curl` or package manager).
   - Copy `pyproject.toml` and `uv.lock` into the image.
   - Run `uv sync --frozen` during build to install deps into a project venv (e.g., `/opt/venv`).
   - Ensure:
     - `PYTHONPATH` is set appropriately (if needed).
     - `PATH` includes the venv bin directory.
2. **Align `docker-compose.yml`**
   - Ensure services referencing Conda-specific paths now use the `uv`-managed environment.
   - Confirm container entrypoints use `uv run` or the venvâ€™s `python` directly (e.g., `python -m app.main`).
3. **Preserve testing workflow**
   - Confirm existing instructions:
     - `docker exec backend /bin/bash`
     - `cd /opt/geist && PYTHONPATH=/opt/geist pytest`
   - Still work with `uv` environment (or update to `uv run pytest` if preferred).

### Phase 5: CI / Automation Updates
1. **Update any CI scripts (if present)**
   - Replace Conda setup steps with:
     - `uv` installation.
     - `uv sync --frozen`.
   - Make sure tests and lint jobs are run via the `uv` environment.
2. **Add a simple `uv` health check**
   - In CI, add a job that:
     - Runs `uv --version`.
     - Validates that `uv sync --frozen` succeeds.

### Phase 6: Documentation & Onboarding
1. **Update `README.md`**
   - Add a **"Environment Setup with uv"** section:
     - How to install `uv`.
     - How to create/sync the environment.
     - How to run backend (`make run MLX_BACKEND=1`, etc.) with the new environment.
   - Clearly state Conda is no longer the primary path.
2. **Add developer notes**
   - Explain:
     - Where dependencies are defined (`pyproject.toml` / `uv.lock`).
     - How to add a new package:
       - `uv add package_name` (then commit updated `uv.lock`).
     - How to run tests:
       - `uv run pytest` locally.

### Phase 7: Validation & Rollout
1. **Functional validation**
   - Run:
     - `docker compose up -d`.
     - Verify no error logs in backend container.
     - `cd /opt/geist && PYTHONPATH=/opt/geist pytest` inside the backend container.
     - `curl` to `localhost:3000` to confirm the app responds.
2. **Cross-platform sanity checks**
   - Validate `uv` setup on:
     - macOS (arm64).
     - Linux (x86_64).
   - Ensure ML-related dependencies work on both (e.g., MLX, Sesame).
3. **Deprecation of Conda artifacts**
   - Once `uv` path is stable:
     - Optionally remove or archive:
       - `linux_environment.yml`, `linux_environment_x86_x64.yml`, `mac_environment_arm.yml`.
       - `conda-install.sh`.
     - Update any remaining references in docs/scripts.

### Success Criteria
- **Environment parity**:
  - All Python dependencies used in production and tests are correctly captured in `uv.lock`.
  - Application behavior matches pre-migration behavior (no missing packages, no version regressions).
- **Developer experience**:
  - New developers can:
    - Install `uv`.
    - Run a single sequence of commands to get a working environment.
    - Use `make` targets exactly as before (but backed by `uv`).
- **Operational stability**:
  - Docker images build successfully with `uv` across supported platforms.
  - CI passes consistently using the `uv`-based environment.
- **Clean migration**:
  - Conda-specific files and scripts are either clearly marked as deprecated or removed after rollout.


