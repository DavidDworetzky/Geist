name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14.9
        env:
          POSTGRES_DB: geist
          POSTGRES_USER: geist
          POSTGRES_PASSWORD: geist
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set up Conda
      uses: conda-incubator/setup-miniconda@v3.1.1
      with:
        python-version: '3.11'
        activate-environment: geist-linux-docker
        environment-file: linux_environment_x86_x64.yml

    - name: Initialize database
      shell: bash -l {0}
      env:
        PYTHONPATH: ${{ github.workspace }}
        DB_HOST: localhost
        DB_PORT: 5432
        POSTGRES_DB: geist
        POSTGRES_USER: geist
        POSTGRES_PASSWORD: geist
      run: |
        python initdb.py

    - name: Run tests
      shell: bash -l {0}
      env:
        HUGGING_FACE_HUB_TOKEN: ${{ secrets.HUGGING_FACE_HUB_TOKEN }}
        PYTHONPATH: ${{ github.workspace }}
        DB_HOST: localhost
        DB_PORT: 5432
        POSTGRES_DB: geist
        POSTGRES_USER: geist
        POSTGRES_PASSWORD: geist
      run: |
        conda info
        conda list
        pytest tests/

  frontend-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: client/geist/package-lock.json

    - name: Install dependencies
      run: |
        cd client/geist
        npm ci

    - name: Run frontend tests
      run: |
        cd client/geist
        npm test -- --watchAll=false --passWithNoTests

  security:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install security tools
      run: |
        pip install bandit safety pyyaml

    - name: Run Bandit (Python SAST)
      run: |
        bandit -r . -f json -o bandit-report.json -c pyproject.toml || true
        if [ -f bandit-report.json ]; then
          echo "üìä Bandit Security Report:"
          python -m json.tool bandit-report.json || cat bandit-report.json
          # Report high severity issues but don't fail
          HIGH_SEVERITY=$(python -c "import json; data=json.load(open('bandit-report.json')); print(len([x for x in data.get('results', []) if x.get('issue_severity') == 'HIGH']))" 2>/dev/null || echo "0")
          if [ "$HIGH_SEVERITY" -gt "0" ]; then
            echo "‚ö†Ô∏è Found $HIGH_SEVERITY high severity security issues!"
          fi
        fi

    - name: Run Safety (Python Dependency Vulnerability Scan)
      run: |
        # Extract pip packages from conda environment file
        python -c "
        import yaml
        import sys
        with open('linux_environment_x86_x64.yml', 'r') as f:
            env = yaml.safe_load(f)
            pip_deps = env.get('dependencies', [])
            for dep in pip_deps:
                if isinstance(dep, dict) and 'pip' in dep:
                    for pkg in dep['pip']:
                        print(pkg)
        " > requirements-check.txt

        safety check --file requirements-check.txt --output json > safety-report.json || true
        if [ -f safety-report.json ]; then
          echo "üîí Safety Vulnerability Report:"
          cat safety-report.json
        fi

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: NPM Audit (Frontend Dependencies)
      run: |
        cd client/geist
        npm install
        npm audit --json > npm-audit-report.json || true
        echo "üì¶ NPM Audit Report:"
        cat npm-audit-report.json
        # Report vulnerabilities but don't fail
        CRITICAL=$(cat npm-audit-report.json | grep -o '"critical":[0-9]*' | cut -d':' -f2 || echo "0")
        if [ "$CRITICAL" != "0" ] && [ ! -z "$CRITICAL" ]; then
          echo "‚ö†Ô∏è Found $CRITICAL critical npm vulnerabilities!"
          npm audit || true
        fi

    - name: Upload Security Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          client/geist/npm-audit-report.json

  container-security:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner on Dockerfiles
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'config'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  build:
    runs-on: ubuntu-latest
    needs: [test, frontend-test, security, container-security]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Backend
      run: docker build -t geist-backend -f Dockerfile .

    - name: Build Frontend
      run: docker build -t geist-frontend -f client/geist/Dockerfile .

    - name: Run Trivy vulnerability scanner on Backend image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'geist-backend'
        format: 'table'
        exit-code: '0'
        severity: 'CRITICAL,HIGH'

    - name: Run Trivy vulnerability scanner on Frontend image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'geist-frontend'
        format: 'table'
        exit-code: '0'
        severity: 'CRITICAL,HIGH'
